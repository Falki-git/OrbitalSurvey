// TODO set science reward dynamically by looking at scalars?
// TODO message box localization

@use "builtin:debug";
@use "builtin:type-conversion";

$LOC-PREFIX: "OrbitalSurvey/Missions/FindDiscoverable/";

/* These are discoverables that already have stock missions, so we'll ignore them (not used)*/
$ignored-discoverables: [
    MohoGiantRock, MohoMoholeCore,
    DresEyeOfDres, DresFinRock,
    GillyObliqueImpact,
    BopCarcass,
    TyloMonument,
    MinmusMonument,
    KerbinCamelRock, KerbinDevilsTower,
    MunMonument,
    LaytheFossil,
    EelooWaveIce,
    DunaMonument,
    VallMineralFormation
];

/* List of discoverables for creating missions */
$bodies-and-regions: {
    Moho : [ MohoPrecariousStack ],
    Eve : [ EveHeartIsland, EvePavement, EveGiantRock, EveTor ],
    "Gilly" : [ GillyGiantRock, GillyPrecariousStack ],
    "Kerbin" : [ KerbinKerb2Summit, KerbinPyramid ],
    "Mun": [ MunArches, MunGiantRock, MunMunOrBust ],
    "Minmus" : [ MinmusBalancingRock ],
    "Duna" : [ DunaFace, DunaGiantRock, DunaMushroomSpire, DunaBrocktonFormation ],
    "Ike" : [ IkeGiantRock, IkeGiantsCauseway ],
    "Dres" : [ DresDoubleArch, DresRamp, DresFinRock ],
    "Laythe" : [ LaytheBallRocks ],
    "Vall" : [ VallPenitente, VallBalancingRock ],
    "Tylo" : [ TyloRampRock, TyloBalancingRock ],
    "Bop" : [ BopBalancingRock, BopSailingStones ],
    "Pol" : [ PolIceTower, PolMineralFormation ],
    "Eeloo" : [ EelooCaptiveRock ],
};



/* returns true if the discoverable is in the ignored list */
@function is-ignored($science-region-id) {
    @each $ignored in $ignored-discoverables {
        @if $science-region-id == $ignored {
            @return true;
        }        
    }

    @return false;
}

/* helpers for creating mission strings */
@function get-mission-id($body, $region-name) {
    @return "orbital_survey_" + $body + "_" + $region-name;
}
@function get-localized-mission-name ($region-name) {
    @return $LOC-PREFIX + $region-name + "/Name";
}
@function get-localized-mission-description ($region-name) {
    @return $LOC-PREFIX + $region-name + "/Description";
}
@function get-localized-brief ($region-name, $brief-number) {
    @return $LOC-PREFIX + $region-name + "/Brief" + $brief-number:to-string();
}
@function get-localized-debrief ($region-name, $debrief-number) {
    @return $LOC-PREFIX + $region-name + "/Debrief" + $debrief-number:to-string();
}
@function get-full-science-region-name ($body, $region-name) {
    @return $body + "_Landed_" + $region-name;
}

/* go through the list of all discoverables, check if they aren't ignored, then create missions for them */
@each $body, $regions in $bodies-and-regions {

    $log: debug-log("Checking " + $body + " for discoverables");    

    @each $region-name in $regions {

        @if is-ignored($region-name) {
            $log: debug-log($region-name + " is on the ignored list. Skipping!");
        } @else {

            $log: debug-log("Creating Orbital Survey mission for " + $region-name);

            $mission-id: get-mission-id($body, $region-name);
            $mission-name: get-localized-mission-name($region-name);
            $mission-description: get-localized-mission-description($region-name);
            $mission-brief1: get-localized-brief($region-name, 1);
            $mission-brief2: get-localized-brief($region-name, 2);
            $mission-debrief1: get-localized-debrief($region-name, 1);
            $mission-debrief2: get-localized-debrief($region-name, 2);
            $full-science-region: get-full-science-region-name($body, $region-name);

            /* CREATE MISSION */
            @new($mission-id)
            :missions {
                "ID": $mission-id;
                "MissionGroup": "";
                "name": $mission-name;
                "description": $mission-description;
                "GameModeFeatureId": "ExplorationMissions";
                "type": "Secondary";
                "Owner": "Agency";
                "state": "Inactive";
                "missionScript": "";
                "missionStages": [

                    // EXPLORE FIRST AREA
                    {
                        "StageID": 10,
                        "name": "ExploreAreaA - Objective",
                        "description": "Land in Area A that may contain the discoverable (optional)",
                        "Objective": "OrbitalSurvey/Missions/FindDiscoverable/OptionalObjective1",
                        "DisplayObjective": true,
                        "RevealObjectiveOnActivate": false,
                        "MissionRewardType": "None",
                        "RewardAmount": null,
                        "MissionReward": {
                        "MissionRewardDefinitions": []
                        },
                        "IgnoreExceptionBranches": false,
                        "actions": [],
                        "branches": [],
                        "scriptableCondition": null,
                        "completed": false,
                        "active": false
                    },
                    {
                        "StageID": 11,
                        "name": "ExploreAreaA - MessageBox & branch to 50",
                        "description": "",
                        "Objective": "",
                        "DisplayObjective": false,
                        "RevealObjectiveOnActivate": false,
                        "MissionRewardType": "None",
                        "RewardAmount": null,
                        "MissionReward": {
                        "MissionRewardDefinitions": []
                        },
                        "IgnoreExceptionBranches": false,
                        "actions": [
                        {
                            "$type": "KSP.Game.Missions.MissionAudioAction, Assembly-CSharp",
                            "StageEvent": "Play_mission_alert_secondary"
                        },
                        {
                            "$type": "KSP.Game.Missions.MessageBoxAction, Assembly-CSharp",
                            "windowTitle": "Area A results",
                            "title": "title",
                            "message": "Director, we haven't found any unusual terrain here. We'll have to look at another location.",
                            "eventType": "KSP.Messages.GoToNextTutorialStep, Assembly-CSharp, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null",
                            "buttonType": "Continue",
                            "imageKey": "",
                            "clipRelativePath": null,
                            "nextMissionID": "",
                            "isMissionSummary": false,
                            "messageDescriptions": {
                            "MessageDescriptionCollection": []
                            },
                            "StageEvent": null
                        }
                        ],
                        "branches": [
                        {
                            "condition": {
                            "$type": "KSP.Game.Missions.EventCondition, Assembly-CSharp",
                            "eventObserved": false,
                            "EventTypeAQN": "KSP.Messages.GoToNextTutorialStep, Assembly-CSharp, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null",
                            "ConditionType": "EventCondition"
                            },
                            "TargetStage": 50,
                            "ExceptionBranch": false
                        }
                        ],
                        "scriptableCondition": null,
                        "completed": false,
                        "active": false
                    },


                    // EXPLORE SECOND AREA
                    {
                        "StageID": 20,
                        "name": "ExploreAreaB",
                        "description": "Land in Area B that may contain the discoverable (optional)",
                        "Objective": "OrbitalSurvey/Missions/FindDiscoverable/OptionalObjective2",
                        "DisplayObjective": true,
                        "RevealObjectiveOnActivate": false,
                        "MissionRewardType": "None",
                        "RewardAmount": null,
                        "MissionReward": {
                        "MissionRewardDefinitions": []
                        },
                        "IgnoreExceptionBranches": false,
                        "actions": [],
                        "branches": [],
                        "scriptableCondition": null,
                        "completed": false,
                        "active": false
                    },
                    {
                        "StageID": 21,
                        "name": "ExploreAreaB - MessageBox & branch to 50",
                        "description": "",
                        "Objective": "",
                        "DisplayObjective": false,
                        "RevealObjectiveOnActivate": false,
                        "MissionRewardType": "None",
                        "RewardAmount": null,
                        "MissionReward": {
                        "MissionRewardDefinitions": []
                        },
                        "IgnoreExceptionBranches": false,
                        "actions": [
                        {
                            "$type": "KSP.Game.Missions.MissionAudioAction, Assembly-CSharp",
                            "StageEvent": "Play_mission_alert_secondary"
                        },
                        {
                            "$type": "KSP.Game.Missions.MessageBoxAction, Assembly-CSharp",
                            "windowTitle": "Area B results",
                            "title": "title",
                            "message": "Director, we haven't found any unusual terrain here. We'll have to look at another location.",
                            "eventType": "KSP.Messages.GoToNextTutorialStep, Assembly-CSharp, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null",
                            "buttonType": "Continue",
                            "imageKey": "",
                            "clipRelativePath": null,
                            "nextMissionID": "",
                            "isMissionSummary": false,
                            "messageDescriptions": {
                            "MessageDescriptionCollection": []
                            },
                            "StageEvent": null
                        }
                        ],
                        "branches": [
                        {
                            "condition": {
                            "$type": "KSP.Game.Missions.EventCondition, Assembly-CSharp",
                            "eventObserved": false,
                            "EventTypeAQN": "KSP.Messages.GoToNextTutorialStep, Assembly-CSharp, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null",
                            "ConditionType": "EventCondition"
                            },
                            "TargetStage": 50,
                            "ExceptionBranch": false
                        }
                        ],
                        "scriptableCondition": null,
                        "completed": false,
                        "active": false
                    },


                    // EXPLORE THIRD AREA - triggered dynamically
                    {
                        "StageID": 30,
                        "name": "ExploreAreaC",
                        "description": "Land in Area C that may contain the discoverable (optional)",
                        "Objective": "OrbitalSurvey/Missions/FindDiscoverable/OptionalObjective3",
                        "DisplayObjective": true,
                        "RevealObjectiveOnActivate": false,
                        "MissionRewardType": "None",
                        "RewardAmount": null,
                        "MissionReward": {
                        "MissionRewardDefinitions": []
                        },
                        "IgnoreExceptionBranches": false,
                        "actions": [],
                        "branches": [],
                        "scriptableCondition": null,
                        "completed": false,
                        "active": false
                    },
                    {
                        "StageID": 31,
                        "name": "ExploreAreaC - MessageBox & branch to 50",
                        "description": "",
                        "Objective": "",
                        "DisplayObjective": false,
                        "RevealObjectiveOnActivate": false,
                        "MissionRewardType": "None",
                        "RewardAmount": null,
                        "MissionReward": {
                        "MissionRewardDefinitions": []
                        },
                        "IgnoreExceptionBranches": false,
                        "actions": [
                        {
                            "$type": "KSP.Game.Missions.MissionAudioAction, Assembly-CSharp",
                            "StageEvent": "Play_mission_alert_secondary"
                        },
                        {
                            "$type": "KSP.Game.Missions.MessageBoxAction, Assembly-CSharp",
                            "windowTitle": "Area C results",
                            "title": "title",
                            "message": "Director, we haven't found any unusual terrain here. We'll have to look at another location.",
                            "eventType": "KSP.Messages.GoToNextTutorialStep, Assembly-CSharp, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null",
                            "buttonType": "Continue",
                            "imageKey": "",
                            "clipRelativePath": null,
                            "nextMissionID": "",
                            "isMissionSummary": false,
                            "messageDescriptions": {
                            "MessageDescriptionCollection": []
                            },
                            "StageEvent": null
                        }
                        ],
                        "branches": [
                        {
                            "condition": {
                            "$type": "KSP.Game.Missions.EventCondition, Assembly-CSharp",
                            "eventObserved": false,
                            "EventTypeAQN": "KSP.Messages.GoToNextTutorialStep, Assembly-CSharp, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null",
                            "ConditionType": "EventCondition"
                            },
                            "TargetStage": 50,
                            "ExceptionBranch": false
                        }
                        ],
                        "scriptableCondition": null,
                        "completed": false,
                        "active": false
                    },


                    // LAND IN THE DISCOVERABLE REGION
                    {
                        "StageID": 50,
                        "name": "Check",
                        "description": "Find the discoverable by landing in its ScienceRegion",
                        "Objective": "OrbitalSurvey/Missions/FindDiscoverable/MainObjective",
                        "DisplayObjective": true,
                        "RevealObjectiveOnActivate": false,
                        "MissionRewardType": "None",
                        "RewardAmount": null,
                        "MissionReward": {
                        "MissionRewardDefinitions": []
                        },
                        "IgnoreExceptionBranches": false,
                        "actions": [],
                        "branches": [],
                        "scriptableCondition": {
                        "$type": "KSP.Game.Missions.PropertyCondition, Assembly-CSharp",
                        "ConditionType": "PropertyCondition",
                        "PropertyTypeAQN": "KSP.Messages.PropertyWatchers.VesselResearchLocation, Assembly-CSharp, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null",
                        "RequireCurrentValue": true,
                        "valueMet": false,
                        "TestWatchedValue": 0,
                        "TestWatchedstring": $full-science-region,
                        "TestWatchedInt": 0,
                        "TestWatchedBool": true,
                        "propOperator": "EQUAL",
                        "isInput": false,
                        "Inputstring": ""
                        },
                        "completed": false,
                        "active": false
                    },
                    {
                        "StageID": 51,
                        "name": "Discoverable found - MessageBox",
                        "description": "",
                        "Objective": "",
                        "DisplayObjective": false,
                        "RevealObjectiveOnActivate": false,
                        "MissionRewardType": "None",
                        "RewardAmount": null,
                        "MissionReward": {
                        "MissionRewardDefinitions": []
                        },
                        "IgnoreExceptionBranches": false,
                        "actions": [
                        {
                            "$type": "KSP.Game.Missions.MissionAudioAction, Assembly-CSharp",
                            "StageEvent": "Play_mission_alert_secondary"
                        },
                        {
                            "$type": "KSP.Game.Missions.MessageBoxAction, Assembly-CSharp",
                            "windowTitle": "SUCCESS!",
                            "title": "",
                            "message": "Director, we found an unusual terrain formation! Isn't it marvelous?!",
                            "eventType": "KSP.Messages.GoToNextTutorialStep, Assembly-CSharp, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null",
                            "buttonType": "Continue",
                            "imageKey": "",
                            "clipRelativePath": null,
                            "nextMissionID": "",
                            "isMissionSummary": false,
                            "messageDescriptions": {
                            "MessageDescriptionCollection": []
                            },
                            "StageEvent": null
                        }
                        ],
                        "branches": [],
                        "scriptableCondition": {
                        "$type": "KSP.Game.Missions.EventCondition, Assembly-CSharp",
                        "eventObserved": false,
                        "EventTypeAQN": "KSP.Messages.GoToNextTutorialStep, Assembly-CSharp, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null",
                        "ConditionType": "EventCondition"
                        },
                        "completed": false,
                        "active": false
                    },

                    // COMPLETE THE MISSION
                    {
                        "StageID": 60,
                        "name": "Mission Complete",
                        "description": "",
                        "Objective": "",
                        "DisplayObjective": false,
                        "RevealObjectiveOnActivate": false,
                        "MissionRewardType": "None",
                        "RewardAmount": null,
                        "MissionReward": {
                        "MissionRewardDefinitions": [
                            {
                            "MissionRewardType": "SciencePoints",
                            "RewardAmount": 3000, // TODO SET DYNAMICALLY
                            "RewardKey": null
                            }
                        ]
                        },
                        "IgnoreExceptionBranches": false,
                        "actions": [
                        {
                            "$type": "KSP.Game.Missions.MissionResolutionAction, Assembly-CSharp",
                            "MissionResolution": "Complete",
                            "summary_PrefabKey": null,
                            "waitForSummaryDismissed": false,
                            "StageEvent": "Play_mission_alert_secondary"
                        }
                        ],
                        "branches": [],
                        "parentMissionID": null,
                        "scriptableCondition": null,
                        "completed": false,
                        "active": false
                    }
                ];
                "currentStageIndex": 6;
                "Hidden": false;
                "MissionGranterKey": "MissionGranterWinterOwl";
                "TriumphLoopVideoKey": "reward_mission_tier1";
                "VisibleRewards": true;
                "pendingCompletionTest": false;
                "maxStageID": 60;
                "uiDisplayType": "Default";
                "ExceptionBranches": [];
                "PreRequisiteBranches": [];
                "ContentBranches": [
                    {
                        "ID": "Brief",
                        "actions": [
                        {
                            "$type": "KSP.Game.Missions.MissionCharacterDialogAction, Assembly-CSharp",
                            "CharacterNameLocKey": "Missions/CharacterName/Keri",
                            "CharacterIconKey": "keri_teaching",
                            "Dialogs": {
                                "Entries": [
                                    {
                                    "ShowsInHistory": true,
                                    "DialogEntryType": "Text",
                                    "LocKey": $mission-brief1,
                                    "ContentAddressableKey": "keri_annoyed"
                                    },
                                    {
                                    "ShowsInHistory": true,
                                    "DialogEntryType": "Text",
                                    "LocKey": $mission-brief2,
                                    "ContentAddressableKey": "keri_teaching"
                                    }
                                ]
                            },
                            "EventTypeOnClosed": "",
                            "StageEvent": ""
                        }
                        ]
                    },
                    {
                        "ID": "Debrief",
                        "actions": [
                            {
                                "$type": "KSP.Game.Missions.MissionCharacterDialogAction, Assembly-CSharp",
                                "CharacterNameLocKey": "Missions/CharacterName/Keri",
                                "CharacterIconKey": "keri_neutral",
                                "Dialogs": {
                                    "Entries": [
                                        {
                                        "ShowsInHistory": true,
                                        "DialogEntryType": "Text",
                                        "LocKey": $mission-debrief1,
                                        "ContentAddressableKey": "keri_joy"
                                        },
                                        {
                                        "ShowsInHistory": true,
                                        "DialogEntryType": "Text",
                                        "LocKey": $mission-debrief2,
                                        "ContentAddressableKey": "keri_happy"
                                        }
                                    ]
                                },
                                "EventTypeOnClosed": "KSP.Messages.SpawnTriumphWindow, Assembly-CSharp, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null",
                                "StageEvent": "Play_mission_alert_primary_returned_to_missionControl"
                            }
                        ]
                    }
                ];
                "MissionSaveAssetKey": "";
            }

            /* END OF MISSION CREATION */
        }
    }
}
